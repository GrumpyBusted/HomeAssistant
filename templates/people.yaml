- binary_sensor:
    - name: anders_home
      unique_id: 853ACC48-200B-4607-B47B-CA9BB9BA0E84
      device_class: presence
      state: >-
        {{ is_state('person.anders', 'home') or is_state('sensor.anders_iphone_ssid', 'Palantir')  }}
      icon: >-
        {% if is_state('binary_sensor.anders_home', 'on') %}
        mdi:account
        {% else %}
        mdi:account-outline
        {% endif %}
- binary_sensor:
    - name: monique_home
      unique_id: 38C5ECC5-28B8-46B5-BED7-53625445DFCB
      device_class: presence
      state: >-
        {{ is_state('person.monique', 'home') or is_state('sensor.monique_iphone_ssid', 'Palantir')  }}
      icon: >-
        {% if is_state('binary_sensor.monique_home', 'on') %}
        mdi:account
        {% else %}
        mdi:account-outline
        {% endif %}
- binary_sensor:
    - name: emil_home
      unique_id: C0544736-ACBB-4C1C-8874-8E18558E8CF5
      device_class: presence
      state: >-
        {{ is_state('person.emil', 'home') or is_state('sensor.emil_iphone_ssid', 'Palantir') }}
      icon: >-
        {% if is_state('binary_sensor.emil_home', 'on') %}
        mdi:account
        {% else %}
        mdi:account-outline
        {% endif %}
- binary_sensor:
    - name: charlie_home
      unique_id: 40083A08-3457-4093-89DC-95E41E763766
      device_class: presence
      state: >-
        {{ is_state('person.charlie', 'home') or is_state('sensor.charlie_iphone_ssid', 'Palantir')  }}
      icon: >-
        {% if is_state('binary_sensor.charlie_home', 'on') %}
        mdi:account
        {% else %}
        mdi:account-outline
        {% endif %}
- binary_sensor:
    - name: parent_home
      unique_id: 1FB2A489-CADC-4F4A-A521-66597D9D6812
      device_class: presence
      state: >-
        {{ is_state('binary_sensor.monique_home', 'on') or 
           is_state('binary_sensor.anders_home', 'on') }}
      icon: >-
        {% if is_state('binary_sensor.parent_home', 'on') %}
        mdi:account-multiple
        {% else %}
        mdi:account-multiple-outline
        {% endif %}
- binary_sensor:
    - name: "family_home"
      unique_id: 557DD664-F523-4959-B4D7-D6BF9355422E
      device_class: presence
      state: >-
        {{ is_state('binary_sensor.parent_home', 'on') or 
           is_state('binary_sensor.emil_home', 'on') or 
           is_state('binary_sensor.charlie_home', 'on') }}
      icon: >-
        {% if is_state('binary_sensor.parent_home', 'on') %}
        mdi:account-group
        {% else %}
        mdi:account-group-outline
        {% endif %}
- binary_sensor:
    - name: "bedroom_occupancy"
      unique_id: 0A2C2AAA-7F34-484D-9BA5-8031FEDF0E11
      state: >-
        {{ states('binary_sensor.bedroom_presence_sensor_occupancy') != 'off' or
           is_state('timer.bedroom_presence_timer', 'active') }}
      icon: >-
        {% if is_state('binary_sensor.bedroom_people_present', 'on') %}
        mdi:location-enter
        {% else %}
        mdi:location-exit
        {% endif %}
- binary_sensor:
    - name: "parent_sleeping"
      unique_id: 6CB2BD82-9ACE-4100-B7B8-DF17E10DD692
      state: >-
        {{
          states('sensor.people_home') | int > 0 and
          is_state('media_player.bedroom_apple_tv_media_player', 'playing') and
          is_state('binary_sensor.bedroom_occupancy', 'on') and
          is_state('binary_sensor.bedroom_blind', 'off') and
          is_state('binary_sensor.bedroom_light', 'off') and
          (
            (
              is_state('person.anders', 'home') and
              is_state('sensor.anders_iphone_battery_state', 'Charging')
            )
            or
            (not is_state('person.anders', 'home'))
          ) and
          (
            (
              is_state('person.monique', 'home') and
              is_state('sensor.monique_iphone_battery_state', 'Charging')
            )
            or
            (not is_state('person.monique', 'home'))
          )
        }}
      icon: >-
        {% if is_state('binary_sensor.parent_sleeping', 'on') %}
        mdi:sleep
        {% else %}
        mdi:sleep-off
        {% endif %}
- binary_sensor:
    - name: "emil_sleeping"
      unique_id: 51259E4B-BF87-448A-839D-0C1996331806
      state: >-
        {{ is_state('binary_sensor.emil_home', 'on') and 
           not(is_state('media_player.emils_room_apple_tv_media_player', 'playing')) and 
           is_state('binary_sensor.emils_room_blind', 'off') and 
           is_state('binary_sensor.emils_room_light', 'off') }}
      icon: >-
        {% if is_state('binary_sensor.emil_sleeping', 'on') %}
        mdi:sleep
        {% else %}
        mdi:sleep-off
        {% endif %}
- binary_sensor:
    - name: "charlie_sleeping"
      unique_id: 56C0C9A8-6803-4F0F-8C5F-9FC9B67D9694
      state: >-
        {{ is_state('binary_sensor.charlie_home', 'on') and 
           not(is_state('media_player.charlies_room_apple_tv_media_player', 'playing')) and 
           is_state('binary_sensor.charlies_room_blind', 'off') and 
           is_state('binary_sensor.charlies_room_light', 'off') }}
      icon: >-
        {% if is_state('binary_sensor.charlie_sleeping', 'on') %}
        mdi:sleep
        {% else %}
        mdi:sleep-off
        {% endif %}
- binary_sensor:
    - name: "everyone_sleeping"
      unique_id: 879F46F0-962B-4061-8BD3-15C179BD85D3
      state: >-
        {{ (is_state('binary_sensor.charlie_home', 'off') or is_state('binary_sensor.charlie_sleeping', 'on')) and 
           (is_state('binary_sensor.emil_home', 'off') or is_state('binary_sensor.emil_sleeping', 'on')) and 
           is_state('binary_sensor.parent_sleeping', 'on') }}
      icon: >-
        {% if is_state('binary_sensor.everyone_sleeping', 'on') %}
        mdi:sleep
        {% else %}
        mdi:sleep-off
        {% endif %}
- sensor:
    - name: people_home
      unique_id: 13A8D2F1-2B67-45C3-8B9D-4A0D1D12F3C8
      state: >-
        {{
          (1 if is_state('binary_sensor.anders_home', 'on') else 0) +
          (1 if is_state('binary_sensor.monique_home', 'on') else 0) +
          (1 if is_state('binary_sensor.charlie_home', 'on') else 0) +
          (1 if is_state('binary_sensor.emil_home', 'on') else 0) +
          (1 if is_state('input_boolean.house_sitter', 'on') else 0)
        }}
      unit_of_measurement: ""
      icon: >-
        {% if is_state('sensor.people_home', '0') %}
        mdi:account-off-outline
        {% else %}
        mdi:account
        {% endif %}
- binary_sensor:
    - name: "people_home"
      unique_id: CB35C9C7-CCB8-4C0D-A1D2-6959B54081D4
      state: >-
        {{ not(is_state('sensor.people_home', '0')) }}
      icon: >-
        {% if is_state('binary_sensor.people_home', 'on') %}
        mdi:home-heart
        {% else %}
        mdi:home-outline
        {% endif %}
- sensor:
    - name: anders_distance_from_home
      unique_id: B6281AE6-4B56-4057-BDE5-CDF6F061FEE3
      unit_of_measurement: "km"
      device_class: distance
      state_class: measurement
      icon: mdi:map-marker-distance
      state: >-
        {% set person_entity = states.person.anders %}
        {% if person_entity.state != 'unknown' and person_entity.state != 'unavailable' %}
          {% set person_lat = person_entity.attributes.latitude %}
          {% set person_lon = person_entity.attributes.longitude %}
          {% set home_lat = state_attr('zone.home', 'latitude') %}
          {% set home_lon = state_attr('zone.home', 'longitude') %}
          {% if person_lat is not none and person_lon is not none and home_lat is not none and home_lon is not none %}
            {{ distance(person_lat, person_lon, home_lat, home_lon) | round(1) }}
          {% else %}
            unknown
          {% endif %}
        {% else %}
          unknown
        {% endif %}
- sensor:
    - name: monique_distance_from_home
      unique_id: 9DF74356-3728-4200-98CB-DC9CF53FD3C5
      unit_of_measurement: "km"
      device_class: distance
      state_class: measurement
      icon: mdi:map-marker-distance
      state: >-
        {% set person_entity = states.person.monique %}
        {% if person_entity.state != 'unknown' and person_entity.state != 'unavailable' %}
          {% set person_lat = person_entity.attributes.latitude %}
          {% set person_lon = person_entity.attributes.longitude %}
          {% set home_lat = state_attr('zone.home', 'latitude') %}
          {% set home_lon = state_attr('zone.home', 'longitude') %}
          {% if person_lat is not none and person_lon is not none and home_lat is not none and home_lon is not none %}
            {{ distance(person_lat, person_lon, home_lat, home_lon) | round(1) }}
          {% else %}
            unknown
          {% endif %}
        {% else %}
          unknown
        {% endif %}
- sensor:
    - name: emil_distance_from_home
      unique_id: C5AFEF61-8351-4869-B5E5-B5710FBC2453
      unit_of_measurement: "km"
      device_class: distance
      state_class: measurement
      icon: mdi:map-marker-distance
      state: >-
        {% set person_entity = states.person.emil %}
        {% if person_entity.state != 'unknown' and person_entity.state != 'unavailable' %}
          {% set person_lat = person_entity.attributes.latitude %}
          {% set person_lon = person_entity.attributes.longitude %}
          {% set home_lat = state_attr('zone.home', 'latitude') %}
          {% set home_lon = state_attr('zone.home', 'longitude') %}
          {% if person_lat is not none and person_lon is not none and home_lat is not none and home_lon is not none %}
            {{ distance(person_lat, person_lon, home_lat, home_lon) | round(1) }}
          {% else %}
            unknown
          {% endif %}
        {% else %}
          unknown
        {% endif %}
- sensor:
    - name: charlie_distance_from_home
      unique_id: C0ECA464-3824-4585-A699-8BA5CC9BB800
      unit_of_measurement: "km"
      device_class: distance
      state_class: measurement
      icon: mdi:map-marker-distance
      state: >-
        {% set person_entity = states.person.charlie %}
        {% if person_entity.state != 'unknown' and person_entity.state != 'unavailable' %}
          {% set person_lat = person_entity.attributes.latitude %}
          {% set person_lon = person_entity.attributes.longitude %}
          {% set home_lat = state_attr('zone.home', 'latitude') %}
          {% set home_lon = state_attr('zone.home', 'longitude') %}
          {% if person_lat is not none and person_lon is not none and home_lat is not none and home_lon is not none %}
            {{ distance(person_lat, person_lon, home_lat, home_lon) | round(1) }}
          {% else %}
            unknown
          {% endif %}
        {% else %}
          unknown
        {% endif %}
- sensor:
    - name: anders_iphone_location_last_updated
      unique_id: BAA94075-3BD2-40A3-A19A-EFBEC6AD20E2
      device_class: timestamp      
      icon: mdi:map-clock
      state: >-
        {{ states.device_tracker.anders_iphone.last_updated }} 
- sensor:
    - name: monique_iphone_location_last_updated
      unique_id: F0526FF2-2E75-4B9B-8432-BD22595C0760
      device_class: timestamp      
      icon: mdi:map-clock
      state: >-
        {{ states.device_tracker.monique_iphone.last_updated }} 
- sensor:
    - name: emil_iphone_location_last_updated
      unique_id: 8EE9F63F-102A-428B-B443-798C03777D5A
      device_class: timestamp      
      icon: mdi:map-clock
      state: >-
        {{ states.device_tracker.emil_iphone.last_updated }} 
- sensor:
    - name: charlie_iphone_location_last_updated
      unique_id: 5007FE64-7563-4FA5-A24A-87B1A6DDDA3A
      device_class: timestamp      
      icon: mdi:map-clock
      state: >- 
        {{ states.device_tracker.charlie_iphone.last_updated }} 
- sensor:
    - name: anders_location
      unique_id: 4818FDD2-DEA0-467D-AC77-9539DD7AC69E
      icon: mdi:map
      state: >-
        {% set name = 'anders' %}
        {% set geo_sensor = 'sensor.' ~ name ~ '_iphone_geocoded_location' %}
        {% set person_state = states('person.' ~ name) %}
        {% if states('input_text.anders_location_override') != '' %}
          {{ states('input_text.anders_location_override') }}
        {% elif person_state == 'home' %}
          Hjemme
        {% elif is_state('sensor.' ~ name ~ '_iphone_ssid', 'Palantir') %}
          Hjemme
        {% elif person_state not in ['', 'not_home', 'away', 'unknown', 'unavailable', None] %}
          {% set zone_entity = 'zone.' ~ person_state %}
          {% set zone_name = state_attr(zone_entity, 'friendly_name') or person_state %}
          {{ zone_name }}
        {% elif is_state('sensor.' ~ name ~ '_iphone_activity', 'Automotive') %}
          På farten
        {% elif is_state_attr(geo_sensor, 'ISO Country Code', 'DK') and state_attr(geo_sensor, 'Locality') is not none %}
          {{ state_attr(geo_sensor, 'Locality').replace('København', 'KBH') }}
        {% elif state_attr(geo_sensor, 'Country') is not none %}
          {{ state_attr(geo_sensor, 'Country') }}
        {% else %}
          Fortabt
        {% endif %}
- sensor:
    - name: monique_location
      unique_id: 4818FDD2-DEA0-467D-AC77-9539DD7AC69A
      icon: mdi:map
      state: >-
        {% set name = 'monique' %}
        {% set geo_sensor = 'sensor.' ~ name ~ '_iphone_geocoded_location' %}
        {% set person_state = states('person.' ~ name) %}
        {% if person_state == 'home' %}
          Hjemme
        {% elif is_state('sensor.' ~ name ~ '_iphone_ssid', 'Palantir') %}
          Hjemme
        {% elif person_state not in ['', 'not_home', 'away', 'unknown', 'unavailable', None] %}
          {% set zone_entity = 'zone.' ~ person_state %}
          {% set zone_name = state_attr(zone_entity, 'friendly_name') or person_state %}
          {{ zone_name }}
        {% elif is_state('sensor.' ~ name ~ '_iphone_activity', 'Automotive') %}
          På farten
        {% elif is_state_attr(geo_sensor, 'ISO Country Code', 'DK') and state_attr(geo_sensor, 'Locality') is not none %}
          {{ state_attr(geo_sensor, 'Locality').replace('København', 'KBH') }}
        {% elif state_attr(geo_sensor, 'Country') is not none %}
          {{ state_attr(geo_sensor, 'Country') }}
        {% else %}
          Fortabt
        {% endif %}
- sensor:
    - name: emil_location
      unique_id: 4818FDD2-DEA0-467D-AC77-9539DD7AC69B
      icon: mdi:map
      state: >-
        {% set name = 'emil' %}
        {% set geo_sensor = 'sensor.' ~ name ~ '_iphone_geocoded_location' %}
        {% set person_state = states('person.' ~ name) %}
        {% if person_state == 'home' %}
          Hjemme
        {% elif is_state('sensor.' ~ name ~ '_iphone_ssid', 'Palantir') %}
          Hjemme
        {% elif person_state not in ['', 'not_home', 'away', 'unknown', 'unavailable', None] %}
          {% set zone_entity = 'zone.' ~ person_state %}
          {% set zone_name = state_attr(zone_entity, 'friendly_name') or person_state %}
          {{ zone_name }}
        {% elif is_state('sensor.' ~ name ~ '_iphone_activity', 'Automotive') %}
          På farten
        {% elif is_state_attr(geo_sensor, 'ISO Country Code', 'DK') and state_attr(geo_sensor, 'Locality') is not none %}
          {{ state_attr(geo_sensor, 'Locality').replace('København', 'KBH') }}
        {% elif state_attr(geo_sensor, 'Country') is not none %}
          {{ state_attr(geo_sensor, 'Country') }}
        {% else %}
          Fortabt
        {% endif %}
- sensor:
    - name: charlie_location
      unique_id: 4818FDD2-DEA0-467D-AC77-9539DD7AC69C
      icon: mdi:map
      state: >-
        {% set name = 'charlie' %}
        {% set geo_sensor = 'sensor.' ~ name ~ '_iphone_geocoded_location' %}
        {% set person_state = states('person.' ~ name) %}
        {% if person_state == 'home' %}
          Hjemme
        {% elif is_state('sensor.' ~ name ~ '_iphone_ssid', 'Palantir') %}
          Hjemme
        {% elif person_state not in ['', 'not_home', 'away', 'unknown', 'unavailable', None] %}
          {% set zone_entity = 'zone.' ~ person_state %}
          {% set zone_name = state_attr(zone_entity, 'friendly_name') or person_state %}
          {{ zone_name }}
        {% elif is_state('sensor.' ~ name ~ '_iphone_activity', 'Automotive') %}
          På farten
        {% elif is_state_attr(geo_sensor, 'ISO Country Code', 'DK') and state_attr(geo_sensor, 'Locality') is not none %}
          {{ state_attr(geo_sensor, 'Locality').replace('København', 'KBH') }}
        {% elif state_attr(geo_sensor, 'Country') is not none %}
          {{ state_attr(geo_sensor, 'Country') }}
        {% else %}
          Fortabt
        {% endif %}
