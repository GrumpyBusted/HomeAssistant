charlies_room_light_desk_adjust:
  alias: Charlies værelse lys skrivebord tilpas
  description: Regulær lysstyrke på lys ved skrivebord på Charlies værelse
  sequence:
  - variables:
      light_entity: light.charlies_room_light_desk_mid
      step: '{{ brightness_step | int }}'
  - target:
      entity_id:
      - light.charlies_room_light_desk_left
      - light.charlies_room_light_desk_mid
      - light.charlies_room_light_desk_right
    data:
      transition: 0.5
      brightness: "{% set current_brightness = state_attr(light_entity, 'brightness')
        | int(0) %} {% if is_state('input_boolean.charlies_room_light_desk_brightness_up',
        'on') %}\n  {% set new_brightness = current_brightness + step %}\n  {% if
        new_brightness > 255 %}\n    {{ 255 }}\n  {% else %}\n    {{ new_brightness
        }}\n  {% endif %}\n{% else %}\n  {% set new_brightness = current_brightness
        - step %}\n  {% if new_brightness < 0 %}\n    {{ 0 }}\n  {% else %}\n    {{
        new_brightness }}\n  {% endif %}\n{% endif %}\n"
    action: light.turn_on
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ is_state(''input_boolean.charlies_room_light_desk_brightness_up'',
          ''on'') and state_attr(light_entity, ''brightness'') | int(0) >= 255 }}

          '
      sequence:
      - target:
          entity_id: input_boolean.charlies_room_light_desk_brightness_up
        action: input_boolean.turn_off
        data: {}
    - conditions:
      - condition: template
        value_template: '{{ is_state(''input_boolean.charlies_room_light_desk_brightness_up'',
          ''off'') and state_attr(light_entity, ''brightness'') | int(0) <= 0 }}

          '
      sequence:
      - target:
          entity_id: input_boolean.charlies_room_light_desk_brightness_up
        action: input_boolean.turn_on
        data: {}
  mode: queued
  max: 10
bedroom_light_sunrise:
  alias: Soveværelse lys solopgang scene
  description: Lys scene til soveværelse til vågn op
  mode: restart
  sequence:
  - event: bedroom_light_sunrise_script
    event_data: {}
  - choose:
    - conditions:
      - condition: state
        entity_id: light.bedroom_lights
        state: 'off'
      sequence:
      - action: light.turn_on
        data:
          transition: 240
          brightness: 100
          rgb_color:
          - 102
          - 102
          - 255
        target:
          entity_id:
          - light.bedroom_light_anders
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_monique
        state: 'off'
      - condition: numeric_state
        entity_id: light.bedroom_light_anders
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 180
          brightness: 100
          rgb_color:
          - 204
          - 153
          - 255
        target:
          entity_id:
          - light.bedroom_light_monique
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_window
        state: 'off'
      - condition: numeric_state
        entity_id:
        - light.bedroom_light_anders
        - light.bedroom_light_monique
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 120
          brightness: 100
          rgb_color:
          - 255
          - 183
          - 94
        target:
          entity_id:
          - light.bedroom_light_window
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_closet
        state: 'off'
      - condition: numeric_state
        entity_id:
        - light.bedroom_light_anders
        - light.bedroom_light_monique
        - light.bedroom_light_window
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 60
          brightness: 100
          rgb_color:
          - 255
          - 128
          - 128
        target:
          entity_id:
          - light.bedroom_light_closet
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    default:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 60
        kelvin: 2700
        brightness_pct: 80
      target:
        entity_id: light.bedroom_lights
bedroom_light_sunset:
  alias: Soveværelse lys solnedgang scene
  description: Lys scene til soveværelse til gå i seng
  mode: restart
  sequence:
  - action: timer.start
    metadata: {}
    data:
      duration: 01:00:00
    target:
      entity_id: timer.bedroom_light_sunset_timer
  - if:
    - condition: state
      entity_id: binary_sensor.bedroom_light
      state: 'off'
    then:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2700
      target:
        entity_id: light.bedroom_lights
  - parallel:
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 204
        - 51
        - 63
      target:
        entity_id:
        - light.bedroom_light_anders
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 153
        - 102
        - 204
      target:
        entity_id:
        - light.bedroom_light_monique
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 255
        - 94
        - 77
      target:
        entity_id:
        - light.bedroom_light_closet
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 255
        - 140
        - 148
      target:
        entity_id:
        - light.bedroom_light_window
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
  - parallel:
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 204
        - 51
        - 63
      target:
        entity_id:
        - light.bedroom_light_anders
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 153
        - 102
        - 204
      target:
        entity_id:
        - light.bedroom_light_monique
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 255
        - 94
        - 77
      target:
        entity_id:
        - light.bedroom_light_closet
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 255
        - 140
        - 148
      target:
        entity_id:
        - light.bedroom_light_window
stue_tand_tv:
  alias: Stue TV tænd
  description: Automatik til at tænde TV i stuen
  icon: mdi:television
  sequence:
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.select_source
    metadata: {}
    data:
      source: Apple TV
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.select_sound_mode
    metadata: {}
    data:
      sound_mode: DOLBY DIGITAL
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.volume_set
    metadata: {}
    data:
      volume_level: 0.25
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.select_source
    metadata: {}
    data:
      source: HDMI 3 (eARC/ARC)
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_apple_tv_media_player
stue_tv_sluk:
  alias: Stue TV sluk
  description: Automatik til at slukke TV i stuen
  icon: mdi:television-off
  sequence:
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_apple_tv_media_player
hjem_motionering_af_radiatorventiler:
  alias: Hjem motionering af radiatorventiler
  description: Skru op og ned op thermostater på alle radiator for at motionere radiatorventiler
  sequence:
  - variables:
      tado_entities:
      - climate.bathroom_radiator_thermostat_floor_tado
      - climate.bathroom_radiator_thermostat_wall_tado
      - climate.bedroom_radiator_thermostat_tado
      - climate.charlies_room_radiator_thermostat_tado
      - climate.emils_room_radiator_thermostat_tado
      - climate.hallway_radiator_thermostat_tado
      - climate.kitchen_radiator_thermostat_tado
      - climate.living_room_radiator_thermostat_bookcase_tado
      - climate.living_room_radiator_thermostat_dining_table_tado
      - climate.living_room_radiator_thermostat_sofa_tado
      - climate.utility_room_radiator_thermostat_wall_tado
      - climate.utility_room_radiator_thermostat_floor_tado
      - climate.toilet_radiator_thermostat_tado
  - action: automation.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - automation.bathroom_heating
      - automation.bedroom_heating
      - automation.charlies_room_heating
      - automation.emils_room_heating
      - automation.hallway_heating
      - automation.living_room_heating
      - automation.utility_room_heating
      - automation.toilet_heating
  - repeat:
      count: '{{ tado_entities | length }}'
      sequence:
      - variables:
          tado_index: '{{ repeat.index - 1 }}'
      - repeat:
          count: 3
          sequence:
          - action: climate.set_temperature
            data:
              entity_id: '{{ tado_entities[tado_index] }}'
              temperature: 30
          - delay: 00:01:00
          - action: climate.set_temperature
            data:
              entity_id: '{{ tado_entities[tado_index] }}'
              temperature: 5
          - delay: 00:01:00
  - action: automation.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - automation.bathroom_heating
      - automation.bedroom_heating
      - automation.charlies_room_heating
      - automation.emils_room_heating
      - automation.hallway_heating
      - automation.living_room_heating
      - automation.utility_room_heating
      - automation.toilet_heating
stue_robotstovsuger_tom_stovbeholder:
  alias: Stue robotstøvsuger tøm støvbeholder
  description: Tøm støv beholder i robotstøvsuger over i docking station
  sequence:
  - if:
    - condition: state
      entity_id: vacuum.living_room_robot_vacuum
      state: docked
    then:
    - action: vacuum.send_command
      data:
        command: app_start_collect_dust
      target:
        entity_id: vacuum.living_room_robot_vacuum
home_robot_vacuum_start_cleaning:
  alias: Stue robotstøvsuger start rengøring
  description: Start robotstøvsuger med at gøre rum rent i et bestemt rum
  mode: queued
  max: 10
  fields:
    type:
      description: Rengøring type
      required: true
      selector:
        select:
          options:
          - vac
          - mop
          - vac_mop
      default: vac
    rooms:
      description: Rum der skal rengøres
      required: true
      selector:
        object: {}
      default:
      - Gang
  sequence:
  - action: system_log.write
    data:
      message: 'Type: {{ type }} - Rooms: {{ rooms }}'
      level: debug
  - action: roborock.get_maps
    data: {}
    target:
      entity_id: vacuum.living_room_robot_vacuum
    response_variable: response
  - variables:
      room_ids: "{% set all_rooms = response['vacuum.living_room_robot_vacuum']['maps'][0]['rooms']
        %} {% set wanted_rooms = rooms %}  {% set room_ids = namespace(value=[]) %}
        {% for key, value in all_rooms.items() %}\n    {% if value in wanted_rooms
        %}\n        {% set room_ids.value = room_ids.value + [key] %}\n    {% endif
        %}\n{% endfor %} {{ room_ids.value }}        "
  - action: system_log.write
    data:
      message: 'Room ids: {{ room_ids }}'
      level: debug
  - choose:
    - conditions:
      - condition: not
        conditions:
        - condition: state
          entity_id: vacuum.living_room_robot_vacuum
          state: docked
      sequence: []
    - conditions:
      - condition: template
        value_template: '{{ type == ''vac'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 200
          entity_id: select.living_room_robot_vacuum_mop_mode
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: max_plus
        target:
          entity_id: vacuum.living_room_robot_vacuum
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity
        data:
          option: 'off'
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode
        data:
          option: standard
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum
    - conditions:
      - condition: template
        value_template: '{{ type == ''mop'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 203
          entity_id: select.living_room_robot_vacuum_mop_mode
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum
        data:
          command: app_start_wash
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: 'off'
        target:
          entity_id: vacuum.living_room_robot_vacuum
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity
        data:
          option: intense
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode
        data:
          option: deep_plus
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum
        data:
          command: app_start_wash
    - conditions:
      - condition: template
        value_template: '{{ type == ''vac_mop'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 201
          entity_id: select.living_room_robot_vacuum_mop_mode
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum
        data:
          command: app_start_wash
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: max
        target:
          entity_id: vacuum.living_room_robot_vacuum
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity
        data:
          option: moderate
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode
        data:
          option: standard
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum
        data:
          command: app_start_wash
living_room_robot_vacuum_dock:
  alias: Stue robotstøvsuger dock
  description: Returner robotstøvsuger til docking station
  sequence:
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: vacuum.living_room_robot_vacuum
        state: docked
    then:
    - action: vacuum.return_to_base
      metadata: {}
      data: {}
      target:
        entity_id: vacuum.living_room_robot_vacuum
home_create_todo_task:
  alias: Hjem opret todo opgave
  description: Kontroller om samme opgave allerede findes hvis ikke opret den i smart
    todo
  icon: mdi:clipboard-list
  fields:
    subject:
      description: Emne for opgaven
      example: Hent post
      required: true
      selector:
        text:
    description:
      description: Beskrivelse af opgaven
      example: Der er ny post i postkassen ved vejen
      required: true
      selector:
        text:
          multiline: true
          multiple: false
    related_entity_id:
      description: Enhed opgaven opstår udfra
      example: light.home_light_a
      required: false
      selector:
        entity:
          domain:
    entity_id:
      description: ToDo listen
      example: todo.my_todo_list
      required: true
      selector:
        entity:
          domain: ms365_todo
    is_active:
      description: Skal opgaven være aktiv?
      example: true/false
      required: true
      selector:
        boolean:
    must_replace:
      description: Skal opgaven erstattes, hvis den findes?
      example: true/false
      required: false
      selector:
        boolean:
      default: false
  sequence:
  - variables:
      todo_entity_id: '[{{ related_entity_id | default(''none'') }}]'
      todo_desciption: "<htrml> {{ description }} {% if todo_entity_id != '[none]'
        %}\n  <br><br>Relateret: {{ todo_entity_id }}\n{% endif %}  </html>"
  - if:
    - condition: template
      value_template: '{{ is_active }}'
    then:
    - variables:
        existing: '{{ state_attr(entity_id, ''all_todos'') | selectattr(''subject'',
          ''equalto'', subject) | rejectattr(''status'', ''equalto'', ''completed'')
          | map(attribute=''todo_id'') | list }}'
    - if:
      - condition: template
        value_template: '{{ existing | length > 0 and must_replace }}'
      then:
      - repeat:
          count: '{{ existing | length }}'
          sequence:
          - action: ms365_todo.complete_todo
            metadata: {}
            data:
              entity_id: '{{ entity_id }}'
              todo_id: '{{ existing[repeat.index - 1] }}'
              completed: true
    - if:
      - condition: template
        value_template: '{{ existing | length == 0 or must_replace }}'
      then:
      - action: ms365_todo.new_todo
        metadata: {}
        data:
          entity_id: '{{ entity_id }}'
          subject: '{{ subject }}'
          description: '{{ todo_desciption }}'
          due: '{{ utcnow().strftime(''%Y-%m-%d'') }}'
          reminder: '{{ utcnow() + timedelta(minutes=1) }}'
    else:
    - if:
      - condition: template
        value_template: '{{ todo_entity != ''[none]'' }}'
      then:
      - variables:
          todo_ids: '{{ state_attr(entity_id, ''all_todos'') |  selectattr(''description'',
            ''contains'', todo_entity_id) |  rejectattr(''status'', ''equalto'', ''completed'')
            |  map(attribute=''todo_id'') |  list }}'
      - repeat:
          count: '{{ todo_ids | length }}'
          sequence:
          - action: ms365_todo.complete_todo
            metadata: {}
            data:
              entity_id: '{{ entity_id }}'
              todo_id: '{{ todo_ids[repeat.index - 1] }}'
              completed: true
home_set_radiator_temperature:
  alias: Hjem sæt radiator temperatur
  description: Sæt temperaturen på flere radiator termostater, men kontroller nuværende
    temperatur først for at undgå unødige kald
  fields:
    entities:
      description: Liste over climate entities der skal opdateres
      example: '"- climate.living_room_thermostat" "- climate.living_room_thermostat"'
      required: true
      selector:
        entity:
          domain: climate
          multiple: true
    temperature:
      description: Ønsket temperatur
      example: 21
      required: true
      selector:
        number:
          min: -10
          max: 30
          unit_of_measurement: °C
  sequence:
  - action: system_log.write
    metadata: {}
    data:
      level: debug
      message: '{{ entities }}'
  - action: system_log.write
    metadata: {}
    data:
      level: debug
      message: '{{ temperature }}'
  - variables:
      entities_to_update: "{% set result = [] %}\n{% for entity in entities %}\n  {%
        if state_attr(entity, 'temperature')|float(default=-100) != temperature %}\n
        \   {% set result = result + [entity] %}\n  {% endif %}\n{% endfor %}\n{{
        result }}"
  - action: system_log.write
    metadata: {}
    data:
      level: debug
      message: '{{ entities_to_update }}'
  - data:
      temperature: '{{ temperature }}'
    target:
      entity_id: '{{ entities_to_update }}'
    action: climate.set_temperature
  mode: parallel
test_script:
  sequence:
  - action: shell_command.append_to_file
    metadata: {}
    data:
      line: '{{ now().isoformat() }},123'
      file: /config/data/meter_reading_electricity.csv
  - action: shell_command.csv_to_json
    metadata: {}
    data:
      csvfile: /config/data/meter_reading_electricity.csv
      jsonfile: /config/data/meter_reading_electricity.json
  - action: file.read_file
    metadata: {}
    data:
      file_name: /config/data/meter_reading_electricity.json
      file_encoding: JSON
    response_variable: res
  - data:
      action: set_state_attributes
      entity_id: sensor.meter_readings_electricity
      state: '{{ now() }}'
      attributes:
      - test: '{{ res.data }}'
    action: python_script.hass_entities
