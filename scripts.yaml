charlies_room_light_desk_adjust:
  alias: Charlies værelse lys skrivebord tilpas
  description: Regulær lysstyrke på lys ved skrivebord på Charlies værelse
  sequence:
  - variables:
      light_entity: light.charlies_room_light_desk_mid_philips_hue
      step: '{{ brightness_step | int }}'
  - target:
      entity_id:
      - light.charlies_room_light_desk_left_philips_hue
      - light.charlies_room_light_desk_mid_philips_hue
      - light.charlies_room_light_desk_right_philips_hue
    data:
      transition: 0.5
      brightness: "{% set current_brightness = state_attr(light_entity, 'brightness')
        | int(0) %} {% if is_state('input_boolean.charlies_room_light_desk_brightness_up',
        'on') %}\n  {% set new_brightness = current_brightness + step %}\n  {% if
        new_brightness > 255 %}\n    {{ 255 }}\n  {% else %}\n    {{ new_brightness
        }}\n  {% endif %}\n{% else %}\n  {% set new_brightness = current_brightness
        - step %}\n  {% if new_brightness < 0 %}\n    {{ 0 }}\n  {% else %}\n    {{
        new_brightness }}\n  {% endif %}\n{% endif %}\n"
    action: light.turn_on
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ is_state(''input_boolean.charlies_room_light_desk_brightness_up'',
          ''on'') and state_attr(light_entity, ''brightness'') | int(0) >= 255 }}

          '
      sequence:
      - target:
          entity_id: input_boolean.charlies_room_light_desk_brightness_up
        action: input_boolean.turn_off
        data: {}
    - conditions:
      - condition: template
        value_template: '{{ is_state(''input_boolean.charlies_room_light_desk_brightness_up'',
          ''off'') and state_attr(light_entity, ''brightness'') | int(0) <= 0 }}

          '
      sequence:
      - target:
          entity_id: input_boolean.charlies_room_light_desk_brightness_up
        action: input_boolean.turn_on
        data: {}
  mode: queued
  max: 10
patio_light_sunset:
  alias: Terrasse lys solnedgang scene
  description: Lys scene på terrasse til hygge lys med sol nedgangs farver
  sequence:
  - parallel:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        brightness_pct: 40
        rgb_color:
        - 253
        - 160
        - 83
      target:
        entity_id:
        - light.patio_light_table_philips_hue
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        brightness_pct: 40
        rgb_color:
        - 240
        - 106
        - 92
      target:
        entity_id:
        - light.patio_light_main_philips_hue
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        brightness_pct: 40
        rgb_color:
        - 199
        - 83
        - 253
      target:
        entity_id:
        - light.patio_light_bar_ledvance_philips_hue
living_room_light_dining:
  alias: Stue lys spise scene
  description: Lys scene til stuen til spise situation
  sequence:
  - parallel:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2700
        brightness_pct: 100
      target:
        entity_id:
        - light.living_room_light_dining_table_philips_hue
        - light.living_room_light_extra_philips_hue
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2700
        brightness_pct: 75
      target:
        entity_id:
        - light.living_room_light_china_cabinet_philips_hue
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2300
        brightness_pct: 50
      target:
        entity_id:
        - light.living_room_light_escher_philips_hue
        - light.living_room_light_joakim_philips_hue
        - light.living_room_light_sofa_spot_philips_hue
    - action: light.turn_off
      metadata: {}
      data:
        transition: 1
      target:
        entity_id:
        - light.living_room_light_sofa_receiver_philips_hue
        - light.living_room_light_sofa_window_philips_hue
        - light.living_room_tv_light_strip_philips_hue
    - action: light.turn_on
      metadata: {}
      data: {}
      target:
        entity_id:
        - light.living_room_light_glass_cabinet_philips_hue
    - action: light.turn_off
      metadata: {}
      data: {}
      target:
        entity_id:
        - light.living_room_light_bookcase_philips_hue
        - light.living_room_light_lamp_philips_hue
  - event: living_room_light_scene
    event_data:
      scene: dining
living_room_light_tv:
  alias: Stue lys TV scene
  description: Lys scene til stuen til TV situation
  sequence:
  - parallel:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2700
        brightness_pct: 75
      target:
        entity_id:
        - light.living_room_tv_light_strip_philips_hue
        - light.living_room_light_escher_philips_hue
        - light.living_room_light_joakim_philips_hue
        - light.living_room_light_sofa_spot_philips_hue
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2300
        brightness_pct: 50
      target:
        entity_id:
        - light.living_room_light_sofa_receiver_philips_hue
        - light.living_room_light_sofa_window_philips_hue
        - light.living_room_light_china_cabinet_philips_hue
    - action: light.turn_off
      metadata: {}
      data:
        transition: 1
      target:
        entity_id:
        - light.living_room_light_dining_table_philips_hue
        - light.living_room_light_extra_philips_hue
    - action: light.turn_on
      metadata: {}
      data: {}
      target:
        entity_id:
        - light.living_room_light_lamp_philips_hue
    - action: light.turn_off
      metadata: {}
      data: {}
      target:
        entity_id:
        - light.living_room_light_bookcase_philips_hue
        - light.living_room_light_glass_cabinet_philips_hue
  - event: living_room_light_scene
    event_data:
      scene: tv
bedroom_light_sunrise:
  alias: Soveværelse lys solopgang scene
  description: Lys scene til soveværelse til vågn op
  mode: restart
  sequence:
  - event: bedroom_light_sunrise_script
    event_data: {}
  - choose:
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_philips_hue
        state: 'off'
      sequence:
      - action: light.turn_on
        data:
          transition: 240
          brightness: 100
          rgb_color:
          - 102
          - 102
          - 255
        target:
          entity_id:
          - light.bedroom_light_anders_philips_hue
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_monique_philips_hue
        state: 'off'
      - condition: numeric_state
        entity_id: light.bedroom_light_anders_philips_hue
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 180
          brightness: 100
          rgb_color:
          - 204
          - 153
          - 255
        target:
          entity_id:
          - light.bedroom_light_monique_philips_hue
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_window_philips_hue
        state: 'off'
      - condition: numeric_state
        entity_id:
        - light.bedroom_light_anders_philips_hue
        - light.bedroom_light_monique_philips_hue
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 120
          brightness: 100
          rgb_color:
          - 255
          - 183
          - 94
        target:
          entity_id:
          - light.bedroom_light_window_philips_hue
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    - conditions:
      - condition: state
        entity_id: light.bedroom_light_closet_philips_hue
        state: 'off'
      - condition: numeric_state
        entity_id:
        - light.bedroom_light_anders_philips_hue
        - light.bedroom_light_monique_philips_hue
        - light.bedroom_light_window_philips_hue
        attribute: brightness
        above: 1
        below: 170
      sequence:
      - action: light.turn_on
        data:
          transition: 60
          brightness: 100
          rgb_color:
          - 255
          - 128
          - 128
        target:
          entity_id:
          - light.bedroom_light_closet_philips_hue
      - action: timer.start
        metadata: {}
        data:
          duration: 60
        target:
          entity_id: timer.bedroom_light_sunrise_delay_timer
    default:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 60
        kelvin: 2700
        brightness_pct: 80
      target:
        entity_id: light.bedroom_light_philips_hue
bedroom_light_sunset:
  alias: Soveværelse lys solnedgang scene
  description: Lys scene til soveværelse til gå i seng
  mode: restart
  sequence:
  - event: bedroom_light_sunset_script
    event_data: {}
  - if:
    - condition: state
      entity_id: binary_sensor.bedroom_light
      state: 'off'
    then:
    - action: light.turn_on
      metadata: {}
      data:
        transition: 1
        kelvin: 2700
      target:
        entity_id: light.bedroom_light_philips_hue
  - parallel:
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 204
        - 51
        - 63
      target:
        entity_id:
        - light.bedroom_light_anders_philips_hue
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 153
        - 102
        - 204
      target:
        entity_id:
        - light.bedroom_light_monique_philips_hue
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 255
        - 94
        - 77
      target:
        entity_id:
        - light.bedroom_light_closet_philips_hue
    - action: light.turn_on
      data:
        transition: 5
        brightness: '{{ brightness_from }}'
        rgb_color:
        - 255
        - 140
        - 148
      target:
        entity_id:
        - light.bedroom_light_window_philips_hue
  - delay:
      hours: 0
      minutes: 0
      seconds: 5
  - parallel:
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 204
        - 51
        - 63
      target:
        entity_id:
        - light.bedroom_light_anders_philips_hue
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 153
        - 102
        - 204
      target:
        entity_id:
        - light.bedroom_light_monique_philips_hue
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 255
        - 94
        - 77
      target:
        entity_id:
        - light.bedroom_light_closet_philips_hue
    - action: light.turn_on
      data:
        transition: '{{ transition }}'
        brightness: '{{ brightness_to }}'
        rgb_color:
        - 255
        - 140
        - 148
      target:
        entity_id:
        - light.bedroom_light_window_philips_hue
stue_tand_tv:
  alias: Stue TV tænd
  description: Automatik til at tænde TV i stuen
  icon: mdi:television
  sequence:
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.select_source
    metadata: {}
    data:
      source: Apple TV
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.select_sound_mode
    metadata: {}
    data:
      sound_mode: DOLBY DIGITAL
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.volume_set
    metadata: {}
    data:
      volume_level: 0.25
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.select_source
    metadata: {}
    data:
      source: HDMI 3 (eARC/ARC)
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_apple_tv_media_player
stue_tv_sluk:
  alias: Stue TV sluk
  description: Automatik til at slukke TV i stuen
  icon: mdi:television-off
  sequence:
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_receiver_denon
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_tv_media_player_sony_bravia
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.living_room_apple_tv_media_player
hjem_motionering_af_radiatorventiler:
  alias: Hjem motionering af radiatorventiler
  description: Skru op og ned op thermostater på alle radiator for at motionere radiatorventiler
  sequence:
  - variables:
      tado_entities:
      - climate.bathroom_radiator_thermostat_floor_tado
      - climate.bathroom_radiator_thermostat_wall_tado
      - climate.bedroom_radiator_thermostat_tado
      - climate.charlies_room_radiator_thermostat_tado
      - climate.emils_room_radiator_thermostat_tado
      - climate.hallway_radiator_thermostat_tado
      - climate.kitchen_radiator_thermostat_tado
      - climate.living_room_radiator_thermostat_bookcase_tado
      - climate.living_room_radiator_thermostat_dining_table_tado
      - climate.living_room_radiator_thermostat_sofa_tado
      - climate.utility_room_radiator_thermostat_wall_tado
      - climate.utility_room_radiator_thermostat_floor_tado
      - climate.toilet_radiator_thermostat_tado
  - action: automation.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - automation.bathroom_heating
      - automation.bedroom_heating
      - automation.charlies_room_heating
      - automation.emils_room_heating
      - automation.hallway_heating
      - automation.living_room_heating
      - automation.utility_room_heating
      - automation.toilet_heating
  - repeat:
      count: '{{ tado_entities | length }}'
      sequence:
      - variables:
          tado_index: '{{ repeat.index - 1 }}'
      - repeat:
          count: 3
          sequence:
          - action: climate.set_temperature
            data:
              entity_id: '{{ tado_entities[tado_index] }}'
              temperature: 30
          - delay: 00:01:00
          - action: climate.set_temperature
            data:
              entity_id: '{{ tado_entities[tado_index] }}'
              temperature: 5
          - delay: 00:01:00
  - action: automation.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - automation.bathroom_heating
      - automation.bedroom_heating
      - automation.charlies_room_heating
      - automation.emils_room_heating
      - automation.hallway_heating
      - automation.living_room_heating
      - automation.utility_room_heating
      - automation.toilet_heating
home_smart_todo_create_task:
  alias: Hjem smart todo opret opgave
  description: Kontroller om samme opgave allerede findes hvis ikke opret den i smart
    todo
  icon: mdi:clipboard-list
  fields:
    subject:
      description: Emne for opgaven
      example: Hent post
      required: true
    description:
      description: Beskrivelse af opgaven
      example: Der er ny post i postkassen ved vejen
      required: true
  sequence:
  - variables:
      existing_tasks: '{{ state_attr(''todo.home_smart_todo'', ''all_todos'') | selectattr(''subject'',
        ''equalto'', subject) | rejectattr(''status'', ''equalto'', ''completed'')
        | list }}'
  - if:
    - condition: template
      value_template: '{{ existing_tasks | length == 0 }}'
    then:
    - action: ms365_todo.new_todo
      metadata: {}
      data:
        entity_id: todo.home_smart_todo
        subject: '{{ subject }}'
        description: '{{ description }}'
        due: '{{ utcnow().strftime(''%Y-%m-%d'') }}'
        reminder: '{{ utcnow() + timedelta(minutes=1) }}'
home_smart_todo_tado:
  alias: Hjem smart todo Tado
  description: Script til at kontrollere batteri tilstand af Tado enheder
  sequence:
  - action: rest_command.tado_get_auth_token
    data:
      secrets:
        tado_username: '{{ states(''sensor.tado_username'') }}'
        tado_password: '{{ states(''sensor.tado_password'') }}'
        tado_client_secret: '{{ states(''sensor.tado_client_secret'') }}'
    response_variable: response
  - variables:
      token: '{{ response.content.access_token }}'
  - action: rest_command.tado_get_profile
    data:
      bearer_token: '{{ token }}'
    response_variable: response
  - variables:
      home_id: '{{ response.content.homes[0].id }}'
  - action: rest_command.tado_get_rooms_and_devices
    data:
      home_id: '{{ home_id }}'
      bearer_token: '{{ token }}'
    response_variable: response
  - variables:
      devices: "[\n  {% for room in response.content.rooms %}\n    {% for device in
        room.devices %}\n      {\n        \"roomName\": \"{{ room.roomName }}\",\n
        \       \"deviceSerialNo\": \"{{ device.serialNumber }}\",\n        \"batteryState\":
        \"{{ device.batteryState }}\",\n        \"type\": \"{{ state_attr('sensor.tado_device_types',
        'types').get(device.type, device.type) }}\",\n        \"location\": \"{{ state_attr('sensor.tado_device_locations',
        'locations').get(device.serialNumber, device.serialNumber) }}\",\n      }{%
        if not loop.last %}, {% endif %}\n    {% endfor %}\n  {% if not loop.last
        %}, {% endif %}\n  {% endfor %}\n]"
  - repeat:
      count: '{{ devices | length }}'
      sequence:
      - if:
        - condition: template
          value_template: '{{ devices[repeat.index - 1].batteryState != ''NORMAL''
            }}'
        then:
        - action: system_log.write
          metadata: {}
          data:
            level: debug
            message: '{{ devices[repeat.index - 1] }}'
        - action: script.home_smart_todo_create_task
          data:
            subject: Skift batteri på {{ devices[repeat.index - 1].type }} i {{ devices[repeat.index
              - 1].roomName }}{{ '' if not devices[repeat.index - 1].location else
              ' (' ~ devices[repeat.index - 1].location ~ ')'}}
            description: Skift batteri på Tado {{ devices[repeat.index - 1].type }}
              med serie no {{ devices[repeat.index - 1].deviceSerialNo }}, der er
              pladseret {{ devices[repeat.index - 1].roomName }}{{ '' if not devices[repeat.index
              - 1].location else ' (' ~ devices[repeat.index - 1].location ~ ')'}},
              batteri status er {{ devices[repeat.index - 1].batteryState }}
stue_robotstovsuger_tom_stovbeholder:
  alias: Stue robotstøvsuger tøm støvbeholder
  description: Tøm støv beholder i robotstøvsuger over i docking station
  sequence:
  - if:
    - condition: state
      entity_id: vacuum.living_room_robot_vacuum_roborock
      state: docked
    then:
    - action: vacuum.send_command
      data:
        command: app_start_collect_dust
      target:
        entity_id: vacuum.living_room_robot_vacuum_roborock
home_robot_vacuum_start_cleaning:
  alias: Stue robotstøvsuger start rengøring
  description: Start robotstøvsuger med at gøre rum rent i et bestemt rum
  mode: queued
  max: 10
  fields:
    type:
      description: Rengøring type
      required: true
      selector:
        select:
          options:
          - vac
          - mop
          - vac_mop
      default: vac
    rooms:
      description: Rum der skal rengøres
      required: true
      selector:
        object: {}
      default:
      - Gang
  sequence:
  - action: system_log.write
    data:
      message: 'Type: {{ type }} - Rooms: {{ rooms }}'
      level: debug
  - action: roborock.get_maps
    data: {}
    target:
      entity_id: vacuum.living_room_robot_vacuum_roborock
    response_variable: response
  - variables:
      room_ids: "{% set all_rooms = response['vacuum.living_room_robot_vacuum_roborock']['maps'][0]['rooms']
        %} {% set wanted_rooms = rooms %}  {% set room_ids = namespace(value=[]) %}
        {% for key, value in all_rooms.items() %}\n    {% if value in wanted_rooms
        %}\n        {% set room_ids.value = room_ids.value + [key] %}\n    {% endif
        %}\n{% endfor %} {{ room_ids.value }}        "
  - action: system_log.write
    data:
      message: 'Room ids: {{ room_ids }}'
      level: debug
  - choose:
    - conditions:
      - condition: not
        conditions:
        - condition: state
          entity_id: vacuum.living_room_robot_vacuum_roborock
          state: docked
      sequence: []
    - conditions:
      - condition: template
        value_template: '{{ type == ''vac'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 200
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: max_plus
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity_roborock
        data:
          option: 'off'
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
        data:
          option: standard
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
    - conditions:
      - condition: template
        value_template: '{{ type == ''mop'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 203
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
        data:
          command: app_start_wash
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: 'off'
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity_roborock
        data:
          option: intense
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
        data:
          option: deep_plus
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
        data:
          command: app_start_wash
    - conditions:
      - condition: template
        value_template: '{{ type == ''vac_mop'' }}'
      sequence:
      - action: vacuum.send_command
        data:
          command: set_water_box_custom_mode
          params:
            water_box_mode: 201
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
        data:
          command: app_start_wash
      - action: vacuum.set_fan_speed
        metadata: {}
        data:
          fan_speed: max
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_intensity_roborock
        data:
          option: moderate
      - action: select.select_option
        target:
          entity_id: select.living_room_robot_vacuum_mop_mode_roborock
        data:
          option: standard
      - action: vacuum.send_command
        data:
          command: app_segment_clean
          params:
          - segments: '{{ room_ids }}'
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
      - action: vacuum.send_command
        target:
          entity_id: vacuum.living_room_robot_vacuum_roborock
        data:
          command: app_start_wash
living_room_robot_vacuum_dock:
  alias: Stue robotstøvsuger dock
  description: Returner robotstøvsuger til docking station
  sequence:
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: vacuum.living_room_robot_vacuum_roborock
        state: docked
    then:
    - action: vacuum.return_to_base
      metadata: {}
      data: {}
      target:
        entity_id: vacuum.living_room_robot_vacuum_roborock
home_create_todo_task:
  alias: Hjem opret todo opgave
  description: Kontroller om samme opgave allerede findes hvis ikke opret den i smart
    todo
  icon: mdi:clipboard-list
  fields:
    subject:
      description: Emne for opgaven
      example: Hent post
      required: true
      selector:
        text:
    description:
      description: Beskrivelse af opgaven
      example: Der er ny post i postkassen ved vejen
      required: true
      selector:
        text:
    entity_id:
      description: Enhed opgaven opstår udfra
      example: light.home_light_a
      required: true
      selector:
        entity:
          domain:
    todo_list:
      description: ToDo listen
      example: todo.my_todo_list
      required: true
      selector:
        entity:
          domain: todo
    is_active:
      description: Skal opgaven være aktiv?
      example: true/false
      required: true
      selector:
        boolean:
  sequence:
  - variables:
      todo_entity_id: '[{{ entity_id }}]'
  - if:
    - condition: template
      value_template: '{{ is_active }}'
    then:
    - variables:
        exists: '{{ state_attr(todo_list, ''all_todos'') |  selectattr(''subject'',
          ''equalto'', subject) |  rejectattr(''status'', ''equalto'', ''completed'')
          |  list | length > 0 }}'
    - if:
      - condition: template
        value_template: '{{ exists }}'
      then:
      - action: ms365_todo.new_todo
        metadata: {}
        data:
          entity_id: '{{ todo_list }}'
          subject: '{{ subject }}'
          description: '{{ description }}

            {{ todo_id }}

            '
          due: '{{ utcnow().strftime(''%Y-%m-%d'') }}'
          reminder: '{{ utcnow() + timedelta(minutes=1) }}'
    else:
    - variables:
        todo_ids: '{{ state_attr(todo_list, ''all_todos'') |  selectattr(''description'',
          ''search'', todo_entity_id) |  rejectattr(''status'', ''equalto'', ''completed'')
          |  map(attribute=''todo_id'') |  list }}'
    - repeat:
        count: '{{ todo_ids | length }}'
        sequence:
        - action: ms365_todo.complete_todo
          metadata: {}
          data:
            entity_id: '{{ todo_list }}'
            todo_id: '{{ todo_ids[repeat.index - 1] }}'
            completed: true
